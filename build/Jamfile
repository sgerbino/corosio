#
# Copyright (c) 2025 Vinnie Falco (vinnie dot falco at gmail dot com)
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
#
# Official repository: https://github.com/cppalliance/corosio
#

import ac ;
import config : requires ;

constant c20-requires :
    [ requires
    cxx20_hdr_concepts
    ]
    ;

path-constant COROSIO_ROOT : .. ;

project boost/corosio
  : requirements
    $(c20-requires)
    <define>BOOST_COROSIO_SOURCE
    <toolset>gcc:<cxxflags>-fcoroutines
  : common-requirements
    <link>shared:<define>BOOST_COROSIO_DYN_LINK
    <link>static:<define>BOOST_COROSIO_STATIC_LINK
  : usage-requirements
    <define>BOOST_COROSIO_NO_LIB
  : source-location $(COROSIO_ROOT)
  ;

local COROSIO_SRC =
    [ glob $(COROSIO_ROOT)/src/*.cpp ]
    [ glob $(COROSIO_ROOT)/src/detail/*.cpp ]
    ;

alias corosio_sources : $(COROSIO_SRC) ;

# System libraries
lib ws2_32 ;

lib boost_corosio
  : corosio_sources
  : requirements
    <library>/boost/capy//boost_capy
    <library>/boost/url//boost_url
    <library>/boost/system//boost_system
    <target-os>windows:<library>ws2_32
    <target-os>windows:<define>_WIN32_WINNT=0x0602
    <include>$(COROSIO_ROOT)/include
    <include>$(COROSIO_ROOT)/src
  : usage-requirements
    <library>/boost/capy//boost_capy
    <library>/boost/url//boost_url
    <library>/boost/system//boost_system
    <target-os>windows:<library>ws2_32
    <include>$(COROSIO_ROOT)/include
  ;

# WolfSSL
using wolfssl ;

alias corosio_wolfssl_sources : [ glob-tree-ex $(COROSIO_ROOT)/src/wolfssl/src : *.cpp ] ;

lib boost_corosio_wolfssl
  : corosio_wolfssl_sources
  : requirements
    <library>/boost/corosio//boost_corosio
    [ ac.check-library /wolfssl//wolfssl : <library>/wolfssl//wolfssl : <build>no ]
  : usage-requirements
    <library>/boost/corosio//boost_corosio
    <define>BOOST_COROSIO_HAS_WOLFSSL
  ;

boost-install boost_corosio boost_corosio_wolfssl ;
